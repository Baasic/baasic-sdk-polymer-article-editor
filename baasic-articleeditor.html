<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../baasic-globals/globals-import.html">
<link rel="import" href="../baasic-globals/config.html">
<link rel="import" href="../baasic-globals/baasic-ajax.html">
<link rel="import" href="../baasic-markdowneditor/baasic-markdowneditor.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../iron-signals/iron-signals.html">

<!--
An element providing a solution to no problem in particular.

Example:

    <baasic-articleeditor></baasic-articleeditor>

@demo
-->
<dom-module id="baasic-articleeditor">

    <template is="dom-if if="{{isAdmin}}">
        <div id="editorBox">
            <paper-input id="txtTitle" label="Article title" floatingLabel></paper-input>
            <baasic-markdowneditor id="editor"></baasic-markdowneditor>
            <div id="rolesList" horizontal layout>
                <div flex one>
                    <h3>Who can view this content?</h3>
                    <template is="dom-repeat" items="{{roles}}">
                        <div horizontal layout>
                            <paper-checkbox name="cbRead" id="{{item.id}}"></paper-checkbox>
                            <label>{{item.name}}</label>
                        </div>
                    </template>
                </div>
                <div flex one>
                    <h3>Who can edit this content?</h3>
                    <template id="tplRoles" is="dom-repeat" items="{{roles}}">
                        <div horizontal layout>
                            <paper-checkbox name="cbEdit" id="{{item.id}}"></paper-checkbox>
                            <label>{{item.name}}</label>
                        </div>
                    </template>
                </div>
            </div>
            <template is="dom-if if="{{!hideSaveButton}}">
                <paper-button on-click="saveChanges">Save</paper-button>
            </template>
        </div>
    </template>
     <iron-signals on-iron-signal-user-login="loginChanged"></iron-signals>
</dom-module>

<script>

  Polymer({

    is: 'baasic-articleeditor',
    behaviors: [Baasic.Ajax, Baasic.Config],
    properties: {
        /**
        * The slug of the article to display. If an article with this slug doesn't exists, it is created automatically.
        * 
        * @attribute slug
        * @type string
        * @default ''
        */
        slug: {
            type: String,
            value: '',
            notify: true
        },
        /**
            * If true, hides the editor save button when it is displayed in dialog boxes or popups that has their own save functionality.
            * 
            * @attribute hideSaveButton
            * @type boolean
            * @default true
            */
        hideSaveButton: {
            type: Boolean,
            value: true,
            notify: true
        },
        /**
            * The article object that is editen. Used in conjuction with auto property, and has to be set if auto is set to false.
            * 
            * @attribute article
            * @type Object
            * @default null
            */
        article: {
            type: Object,
            value: null,
            notify: true,
            observer: 'articleChanged'
        },
        /**
            * If true, the element automatically fetches the article from the Baasic service. Set to false if it is used on the same page as the baasic-article element to avoid double GETs.
            * 
            * @attribute auto
            * @type boolean
            * @default false
            */
        auto: {
            type: Boolean,
            value: false,
            notify: true
        },
      
    },
    isAdmin: false,
    articleExists: false,
    // Element Lifecycle

    ready: function() {
        this.loadLookups();
        this.fetchData();
    },

    loadLookups: function() {
        Baasic.Ajax.getFromCache(this.baseUrl + '/' + this.version + '/' + this.application + '/roles/?rpp=100&sort=Name|asc', 'baasicRoles', 'item', this.cacheExpiration)
            .then(function (d) { this.roles = d.data; this.setValues(); }.bind(this))
            .catch(function (d) { console.log(d) });

        Baasic.Ajax.getFromCache(this.baseUrl + '/' + this.version + '/' + this.application + '/lookups/?embed=accessAction', 'baasicActions', 'accessAction', this.cacheExpiration)
            .then(function (d) { this.setAccessActions(d.data); this.setValues(); }.bind(this))
            .catch(function (d) { console.log(d) });
    },
    articleChanged: function (newValue, oldValue) {
        //if article does not exist, the element will issue a POST call to create it when Save button is clicked, otherwise a PUT call will be issued to update the existing article
        if (newValue)
            this.articleExists = true;
        else
            this.articleExists = false;
        //set article content and role checkboxes
        this.setValues();
    },

    attached: function() {
        // `attached` fires once the element and its parents have been inserted
        // into a document.
        //
        // This is a good place to perform any work related to your element's
        // visual state or active behavior (measuring sizes, beginning animations,
        // loading resources, etc).
    },

    detached: function() {
        // The analog to `attached`, `detached` fires when the element has been
        // removed from a document.
        //
        // Use this to clean up anything you did in `attached`.
    },

    // Element Behavior

    /**
        * The `baasic-articleeditor-lasers` event is fired whenever `fireLasers` is called.
        *
        * @event baasic-articleeditor-lasers
        * @detail {{sound: String}}
        */

    /**
        * Sometimes it's just nice to say hi.
        *
        * @param {string} greeting A positive greeting.
        * @return {string} The full greeting.
        */
    sayHello: function(greeting) {
        var response = greeting || 'Hello World!';
        return 'baasic-articleeditor says, ' + response;
    },

    /**
        * Attempts to destroy this element's enemies with an any beam of light!
        *
        * Or, at least, dispatches an event in the vain hope that someone else will
        * do the zapping.
        */
    fireLasers: function() {
        this.fire('baasic-articleeditor-lasers', {sound: 'Pew pew!'});
    }

  });

</script>
