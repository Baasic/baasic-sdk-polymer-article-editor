<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../baasic-ajax/baasic-ajax.html">
<link rel="import" href="../baasic-crud/baasic-crud.html">
<link rel="import" href="../baasic-globals/baasic-globals.html">
<link rel="import" href="../markdown-editor/markdown-editor.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../core-signals/core-signals.html">


<polymer-element name="baasic-articleeditor" attributes="baseUrl version application slug value hideSaveButton">
    <template>
        <style>
            :host {
                display: block;
            }

            paper-checkbox {
                padding: 20px 20px 20px 0;
            }
        </style>
        <div id="container">
            <template bind if="{{!baasicUser.isAdmin}}">
                You are not allowed to access this section. Please check your login information or contact the administrator to obtain the right credentials.
            </template>

            <template bind if="{{baasicUser.isAdmin}}">
                <div id="editorBox" vertical layout>
                    <div>
                        <paper-input id="txtTitle" label="Article title"></paper-input>
                    </div>
                    <div>
                        <markdown-editor id="editor"></markdown-editor>
                    </div>
                    <div id="rolesList" vertical layout>
                        <div>Who can view this content?</div>
                        <template repeat="{{ role in roles }}">
                            <div horizontal layout>
                                <paper-checkbox name="cbRead" id="{{role.id}}"></paper-checkbox>
                                <div>{{ role.name }}</div>
                            </div>
                        </template>
                    </div>
                    <template bind if="{{!hideSaveButton}}">
                        <div>
                            <paper-button on-click="{{saveChanges}}" label="Save" raisedbutton></paper-button>
                        </div>
                    </template>
                </div>
            </template>


        </div>
        <baasic-globals id="globals"></baasic-globals>

        <core-signals on-core-signal-user-login="{{loginChanged}}"></core-signals>

        <baasic-crud id="crudElement"
                     geturl="{{baseUrl}}/{{version}}/{{application}}/article/{{slug}}"
                     posturl="{{baseUrl}}/{{version}}/{{application}}/article/"
                     puturl="{{baseUrl}}/{{version}}/{{application}}/article/{{slug}}/"
                     deleteurl="{{baseUrl}}/{{version}}/{{application}}/article/{{slug}}/"
                     on-get-completed="{{handleGetCompleted}}"
                     on-get-error="{{handleGetError}}"></baasic-crud>

        <baasic-ajax id="axRoles"
                     url="{{baseUrl}}/{{version}}/{{application}}/role/?rpp=100&sort=Name|asc"
                     handleas="json"
                     contenttype="application/json"
                     method="GET"
                     on-core-response="{{handleGetRolesCompleted}}"
                     on-core-error="{{handleGetRolesError}}"></baasic-ajax>
    </template>
    <script>
        Polymer('baasic-articleeditor', {
            baseUrl: "http://api.baasic.local",
            version: "beta",
            application: "",
            slug: "",
            response: {},
            roles: {},
            articleExists: true,
            ready: function () {
                //pick up the user from the local storage
                this.baasicUser = this.$.globals.baasicUser;
                //this.isAdmin = this.$.globals.isAdmin();
                //load all available roles from the system, as they will be shown in checkbox lists
                this.$.axRoles.go();
                this.crud = this.$.crudElement;
                //get the article
                this.crud.get({ embed: "Authors,Tags" });
            },
            loginChanged: function (data) {
                this.baasicUser = this.$.globals.baasicUser;
                //this.isAdmin = this.$.globals.isAdmin();
                this.crud.get({ embed: "Authors,Tags" });
            },
            handleGetCompleted: function (e) {
                this.response = e.detail.response;
                if (this.$.container.querySelector('#editor'))
                    this.$.container.querySelector('#editor').value = this.response.content;
                if (this.$.container.querySelector('#txtTitle'))
                    this.$.container.querySelector('#txtTitle').value = this.response.title;
            },
            handleGetError: function (e) {
                this.articleExists = false;
            },
            handleGetRolesCompleted: function (e) {
                this.roles = e.detail.response.item;
            },
            handleGetRolesError: function (e) {
            },
            saveChanges: function (e) {
                //to retrieve nodes from the light DOM, but present in a child template, put a master div around all templates with ID "container" and use the line below
                var content = this.$.container.querySelector('#editor').value;
                var title = this.$.container.querySelector('#txtTitle').value;
                var article = {
                    title: title,
                    content: content,
                    allowComments: "false",
                    status: "2",
                    publishDate: new Date(),
                    slug: String.slugify(title),
                    permissions: [
                        {
                            actionId: "1fcc74f9-8d49-43b4-8d6a-a365011ad3f7",
                            roleId: "a5585691-b02e-47fa-be4c-a365011ad38c"
                        }
                    ]
                };
                var body = JSON.stringify(article);
                if (this.articleExists)
                    this.crud.put(null, body);
                else {
                    this.crud.post(null, body);
                    this.articleExists = true;
                }
                //parsing roles
                var cbs = this.shadowRoot.querySelectorAll("[name^='cbRead']");
                for (i = 0; i < cbs.length; i++) {
                    console.log(cbs[i].checked + "-" + cbs[i].id);
                }
                this.fire('article-save', { title: title, content: content });
            }
        });
    </script>
</polymer-element>


