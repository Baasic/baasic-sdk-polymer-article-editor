<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../baasic-ajax/baasic-ajax.html">
<link rel="import" href="../baasic-crud/baasic-crud.html">
<link rel="import" href="../baasic-globals/baasic-globals.html">
<link rel="import" href="../markdown-editor/markdown-editor.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../core-signals/core-signals.html">


<polymer-element name="baasic-articleeditor" attributes="baseUrl version application slug value hideSaveButton">
    <template>
        <style>
            :host {
                display: block;
            }

            paper-checkbox {
                padding: 20px 20px 20px 0;
            }
        </style>
        <div id="container">
            <template bind if="{{!baasicUser.isAdmin}}">
                You are not allowed to access this section. Please check your login information or contact the administrator to obtain the right credentials.
            </template>

            <template bind if="{{baasicUser.isAdmin}}">
                <div id="editorBox" vertical layout>
                    <div>
                        <paper-input id="txtTitle" label="Article title"></paper-input>
                    </div>
                    <div>
                        <markdown-editor id="editor"></markdown-editor>
                    </div>
                    <div id="rolesList" vertical layout>
                        <div>Who can view this content?</div>
                        <template repeat="{{ role in roles }}">
                            <div horizontal layout>
                                <paper-checkbox name="cbRead" id="{{role.id}}"></paper-checkbox>
                                <div>{{ role.name }}</div>
                            </div>
                        </template>
                        <div>Who can edit this content?</div>
                        <template repeat="{{ role in roles }}">
                            <div horizontal layout>
                                <paper-checkbox name="cbEdit" id="{{role.id}}"></paper-checkbox>
                                <div>{{ role.name }}</div>
                            </div>
                        </template>
                    </div>
                    <template bind if="{{!hideSaveButton}}">
                        <div>
                            <paper-button on-click="{{saveChanges}}" label="Save" raisedbutton></paper-button>
                        </div>
                    </template>
                </div>
            </template>


        </div>
        <baasic-globals id="globals"></baasic-globals>

        <core-signals on-core-signal-user-login="{{loginChanged}}"></core-signals>

        <baasic-crud id="crudElement"
                     geturl="{{baseUrl}}/{{version}}/{{application}}/article/{{slug}}/"
                     posturl="{{baseUrl}}/{{version}}/{{application}}/article/"
                     puturl="{{baseUrl}}/{{version}}/{{application}}/article/{{slug}}/"
                     deleteurl="{{baseUrl}}/{{version}}/{{application}}/article/{{slug}}/"
                     on-get-completed="{{handleCrudCompleted}}"
                     on-get-error="{{handleCrudError}}"></baasic-crud>

        <baasic-ajax id="axRoles"
                     url="{{baseUrl}}/{{version}}/{{application}}/role/?rpp=100&sort=Name|asc"
                     handleas="json"
                     contenttype="application/json"
                     method="GET"
                     on-core-response="{{handleGetRolesCompleted}}"
                     on-core-error="{{handleGetRolesError}}"></baasic-ajax>

        <baasic-ajax id="axActions"
                     url="{{baseUrl}}/{{version}}/{{application}}/lookup/?embed=accessAction"
                     handleas="json"
                     contenttype="application/json"
                     method="GET"
                     on-core-response="{{handleGetActionsCompleted}}"
                     on-core-error="{{handleGetActionsError}}"></baasic-ajax>

    </template>
    <script>
        Polymer('baasic-articleeditor', {
            slug: "",
            response: {},
            roles: {},
            articleExists: true,
            ready: function () {
                this.globals = this.$.globals;
                if (!this.baseUrl) this.baseUrl = this.globals.config.baseUrl;
                if (!this.version) this.version = this.globals.config.version;
                if (!this.application) this.application = this.globals.config.application;

                //pick up the user from the local storage
                this.baasicUser = this.globals.baasicUser;
                //load all available roles from the system, as they will be shown in checkbox lists
                this.$.axRoles.go();
                //load the access actions
                this.$.axActions.go();

                this.crud = this.$.crudElement;
                //get the article
                this.crud.get({ embed: "Authors,Tags" });
            },
            loginChanged: function (data) {
                this.baasicUser = this.globals.baasicUser;
                this.crud.get({ embed: "Authors,Tags" });
            },
            handleCrudCompleted: function (e) {
                this.response = e.detail.response;
                console.log(this.response);
                if (this.$.container.querySelector('#editor'))
                    this.$.container.querySelector('#editor').value = this.response.content;
                if (this.$.container.querySelector('#txtTitle'))
                    this.$.container.querySelector('#txtTitle').value = this.response.title;
                this.displayRoles(this.response.permissions);

            },
            handleCrudError: function (e) {
                this.articleExists = false;
            },
            handleGetRolesCompleted: function (e) {
                this.roles = e.detail.response.item;
            },
            handleGetRolesError: function (e) {
                console.log(e.detail.response);
            },
            handleGetActionsCompleted: function (e) {
                this.accessActions = {};
                var actions = e.detail.response.accessAction;
                for (var i = 0, len = actions.length; i < len; i++) {
                    this.accessActions[actions[i].abrv] = actions[i];
                }
            },
            handleGetActionsError: function (e) {
                console.log(e.detail.response);
            },
            saveChanges: function (e) {
                //to retrieve nodes from the light DOM, but present in a child template, put a master div around all templates with ID "container" and use the line below
                var content = this.$.container.querySelector('#editor').value;
                var title = this.$.container.querySelector('#txtTitle').value;
                var article = {
                    title: title,
                    content: content,
                    allowComments: "false",
                    status: "2",
                    publishDate: new Date(),
                    slug: String.slugify(title),
                    permissions: this.parseRoles()
                };
                var body = JSON.stringify(article);
                if (this.articleExists)
                    this.crud.put(null, body);
                else {
                    this.crud.post(null, body);
                    this.articleExists = true;
                }
                this.fire('article-save', { title: title, content: content });
            },
            displayRoles: function(permissions) {
                var cbs = this.shadowRoot.querySelectorAll("[name^='cbRead']");
                var readAction = this.accessActions['Read'];
                for (i = 0; i < cbs.length; i++) {
                    var exists = permissions.filter(function (p) {
                        return p.actionId === readAction.id && p.roleId === cbs[i].id;
                    });
                    if (exists.length)
                        cbs[i].checked = true;
                }
            },
            parseRoles: function () {
                var permArr = [];
                //parsing roles
                var readAction = this.accessActions['Read'];
                var cbs = this.shadowRoot.querySelectorAll("[name^='cbRead']");
                for (i = 0; i < cbs.length; i++) {
                    if (cbs[i].checked) {
                        permArr.push({
                            actionId: readAction.id,
                            roleId: cbs[i].id
                        });
                    }
                }
                var updateAction = this.accessActions['Update'];
                cbs = this.shadowRoot.querySelectorAll("[name^='cbEdit']");
                for (i = 0; i < cbs.length; i++) {
                    if (cbs[i].checked) {
                        permArr.push({
                            actionId: updateAction.id,
                            roleId: cbs[i].id
                        });
                    }
                }
                return permArr;
            }
        });
    </script>
</polymer-element>


