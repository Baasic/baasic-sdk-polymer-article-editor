<!--
Copyright (c) 2014 Mono d.o.o. All rights reserved.
Code distributed by Mono as a part of the Baasic project
-->

<!--
@group Baasic Polymer Elements

The `baasic-articleeditor` element provides elementary functionality for editing the content, title and permissions of Baasic articles.

    <baasic-articleeditor
        auto=false
        application="webcomponents" 
        article="{{article}}" slug="{{slug}}"
        hideSaveButton="true" 
        on-article-save="{{reload}}></baasic-articleeditor>
 
With `auto` set to `true`, the element fires a GET request fetching the article object automatically. `baseUrl`, `version`, and `application` attributes can be set in the globals element for the whole application, and do not have to be set for each individual element.
The element is by default used with the `baasic-article` element that provides article preview functionality, and is displayed in a `paper-dialog`. 
To use it stand-alone, set the auto property and hideSaveButtons to false.

@element baasic-articleeditor
@status beta
@homepage www.baasic.com
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../baasic-ajax/baasic-ajax.html">
<link rel="import" href="../baasic-crud/baasic-crud.html">
<link rel="import" href="../baasic-globals/baasic-globals.html">
<link rel="import" href="../baasic-markdowneditor/baasic-markdowneditor.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../core-signals/core-signals.html">

<polymer-element name="baasic-articleeditor" attributes="baseUrl version application slug hideSaveButton article auto">
    <template>
        <style>
            :host {
                display: block;
            }

            paper-checkbox {
                padding: 20px 20px 20px 0;
            }
        </style>
        <template bind if="{{!isAdmin}}">
            You are not allowed to access this section. Please check your login information or contact the administrator to obtain the right credentials.
        </template>

        <template bind if="{{isAdmin}}">
            <div id="editorBox" vertical layout>
                <div>
                    <paper-input id="txtTitle" label="Article title"></paper-input>
                </div>
                <div>
                    <baasic-markdowneditor id="editor"></baasic-markdowneditor>
                </div>
                <div id="rolesList" vertical layout>
                    <div>Who can view this content?</div>
                    <template repeat="{{ role in roles }}">
                        <div horizontal layout>
                            <paper-checkbox name="cbRead" id="{{role.id}}"></paper-checkbox>
                            <div>{{ role.name }}</div>
                        </div>
                    </template>
                    <div>Who can edit this content?</div>
                    <template repeat="{{ role in roles }}">
                        <div horizontal layout>
                            <paper-checkbox name="cbEdit" id="{{role.id}}"></paper-checkbox>
                            <div>{{ role.name }}</div>
                        </div>
                    </template>
                </div>
                <template bind if="{{!hideSaveButton}}">
                    <div>
                        <paper-button on-click="{{saveChanges}}" label="Save" raisedbutton></paper-button>
                    </div>
                </template>
            </div>
        </template>


        <baasic-globals id="globals"></baasic-globals>

        <core-signals on-core-signal-user-login="{{loginChanged}}"></core-signals>

        <baasic-crud id="crudElement"
                     geturl="{{baseUrl}}/{{version}}/{{application}}/article/{{slug}}/"
                     posturl="{{baseUrl}}/{{version}}/{{application}}/article/"
                     puturl="{{baseUrl}}/{{version}}/{{application}}/article/{{slug}}/"
                     deleteurl="{{baseUrl}}/{{version}}/{{application}}/article/{{slug}}/"
                     on-get-completed="{{handleCrudCompleted}}"
                     on-get-error="{{handleCrudError}}"></baasic-crud>

    </template>
    <script>
        Polymer('baasic-articleeditor', {
            /**
             * Fired when the article is saved back to the Baasic system.
             * 
             * @event article-save
             */
            /**
             * The URL target of the Baasic service. Can be used with baasic-globals element to set the property for all baasic elements in one place.
             * 
             * @attribute baseUrl
             * @type string
             * @default ''
             */
            baseUrl: '',
            /**
             * The versione Baasic service. Can be used with baasic-globals element to set the property for all baasic elements in one place.
             * 
             * @attribute version
             * @type string
             * @default ''
             */
            version: '',
            /**
             * The name of the Baasic application, unique per user. Can be used with baasic-globals element to set the property for all baasic elements in one place.
             * 
             * @attribute application
             * @type string
             * @default ''
             */
            application: '',
            /**
             * The slug of the article to display. If an article with this slug doesn't exists, it is created automatically.
             * 
             * @attribute slug
             * @type string
             * @default ''
             */
            slug: '',
            /**
             * If true, hides the editor save button when it is displayed in dialog boxes or popups that has their own save functionality.
             * 
             * @attribute hideSaveButton
             * @type boolean
             * @default true
             */
            hideSaveButton: true,
            /**
             * The article object that is editen. Used in conjuction with auto property, and has to be set if auto is set to false.
             * 
             * @attribute article
             * @type Object
             * @default null
             */
            article: null,
            /**
             * If true, the element automatically fetches the article from the Baasic service. Set to false if it is used on the same page as the baasic-article element to avoid double GETs.
             * 
             * @attribute auto
             * @type boolean
             * @default false
             */
            auto: false,
            isAdmin: false,
            //roles: {},
            //articleExists: true,
            ready: function () {
                this.globals = this.$.globals;
                if (!this.baseUrl) this.baseUrl = this.globals.config.baseUrl;
                if (!this.version) this.version = this.globals.config.version;
                if (!this.application) this.application = this.globals.config.application;

                //load all available roles from the system, as they will be shown in checkbox lists
                this.roles = this.globals.roles;
                //load the access actions
                this.setAccessActions();

                this.crud = this.$.crudElement;
                this.fetchData();
            },
            articleChanged: function (oldValue, newValue) {
                if (newValue)
                    this.articleExists = true;
                else
                    this.articleExists = false;
                this.setValues();
            },
            loginChanged: function (data) {
                if (this.auto)
                    this.fetchData();
            },
            fetchData: function() {
                //pick up user rights from the local storage
                this.isAdmin = this.globals.baasicUser.isAdmin;
                //get the article if it is not set via element article attribute
                if (this.auto) {
                    this.crud.get({ embed: 'Authors,Tags' });
                }
            },
            handleCrudCompleted: function (e) {
                this.article = e.detail.response;
                this.setValues();
            },
            setValues: function () {
                if (this.article) {
                    if (this.shadowRoot.getElementById('editor'))
                        //need to set this asynchronously, otherwise it tens to crash the browser and exhibit other strange behavior
                        this.job('setEditorValue', this.setEditorValue, 0);
                    if (this.shadowRoot.getElementById('txtTitle'))
                        this.shadowRoot.getElementById('txtTitle').value = this.article.title;
                    this.displayRoles(this.article.permissions);
                }
            },
            setEditorValue: function () {
                this.shadowRoot.getElementById('editor').value = this.article.content;
            },
            handleCrudError: function (e) {
                this.articleExists = false;
            },
            setAccessActions: function () {
                this.accessActions = {};
                var actions = this.globals.actions;
                for (var i = 0, len = actions.length; i < len; i++) {
                    this.accessActions[actions[i].abrv] = actions[i];
                }
            },
            saveChanges: function (e) {
                var content = this.shadowRoot.getElementById('editor').value;
                var title = this.shadowRoot.getElementById('txtTitle').value;
                var article = {
                    title: title,
                    content: content,
                    allowComments: "false",
                    //status - published
                    status: "2",
                    publishDate: new Date(),
                    //dynamic alternative would be slug: String.slugify(title), but let's stick to simpler scneario
                    slug: this.slug,
                    permissions: this.parseRoles()
                };
                var body = JSON.stringify(article);
                if (this.articleExists)
                    this.crud.put(null, body);
                else {
                    this.crud.post(null, body);
                    this.articleExists = true;
                }
                this.fire('article-save', { title: title, content: content });
            },
            refresh: function () {
                this.shadowRoot.getElementById('editor').refresh();
            },
            displayRoles: function(permissions) {
                this.setCheckboxes("[name^='cbRead']", 'Read', permissions);
                this.setCheckboxes("[name^='cbEdit']", 'Update', permissions);
            },
            setCheckboxes: function (selector, action, permissions) {
                var cbs = this.shadowRoot.querySelectorAll(selector);
                var readAction = this.accessActions[action];
                for (i = 0; i < cbs.length; i++) {
                    var exists = permissions.filter(function (p) {
                        return p.actionId === readAction.id && p.roleId === cbs[i].id;
                    });
                    if (exists.length)
                        cbs[i].checked = true;
                }
            },
            parseRoles: function () {
                var permArr = [];
                this.setPermissions("[name^='cbRead']", 'Read', permArr);
                this.setPermissions("[name^='cbEdit']", 'Update', permArr);
                return permArr;
            },
            setPermissions: function (selector, action, permArr) {
                var action = this.accessActions[action];
                var cbs = this.shadowRoot.querySelectorAll(selector);
                for (i = 0; i < cbs.length; i++) {
                    if (cbs[i].checked) {
                        permArr.push({
                            actionId: action.id,
                            roleId: cbs[i].id
                        });
                    }
                }
            }
        });
    </script>
</polymer-element>


